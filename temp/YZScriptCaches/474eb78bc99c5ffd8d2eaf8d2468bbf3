"use strict";var appUtils={};appUtils.updateUrlWithStamp=function(n,t){var t=(t||"t")+"=",e=new RegExp(t+"\\d+"),o=+new Date;if(n.indexOf(t)>-1)return n.replace(e,t+o);if(n.indexOf("?")>-1){var i=n.split("?");return i[1]?i[0]+"?"+t+o+"&"+i[1]:i[0]+"?"+t+o}return n.indexOf("#")>-1?n.split("#")[0]+"?"+t+o+location.hash:n+"?"+t+o},appUtils.preset={errorModal:{content:{html:"糟糕，网络不给力"},confirm:{html:"重新进入",click:function(){window.location.href=appUtils.updateUrlWithStamp(window.location.href)}},cancel:"remove"}},appUtils.modal=function(){function n(){o&&o.remove(),o=$($("#apps-modal-tpl").html()),i={};for(var n in c)i[n]=o.find(".js-apps-modal-"+n)}function t(t){n();var e,o,a;for(e in t)if("string"!=typeof t[e])for(o in t[e])a=i[e][o],$.isFunction(a)&&a.call(i[e],t[e][o]);else"remove"==t[e]&&i[e].remove()}function e(n){return $.extend(!0,{},c,n)}var o,i,a={open:function(n){t(e(n)),$(document.body).append(o)},close:function(n){n===!0?o.find(".apps-modal").remove():o&&o.remove()}},c={content:{html:""},confirm:{html:"确定",click:$.noop},cancel:{html:"取消",click:a.close}};return a}(),appUtils.process=function(){function n(n){c.cancel.html=n,l.cancel.html=n}function t(){return 0!==i?10999==i?(a.open(c),!1):10998==i?(a.open(l),!1):(a.open(s),!1):0===o.costPoint||void 0==o.costPoint||(a.open(r),!1)}var e,o=_apps_global,i=o.errorCode,a=appUtils.modal,c={content:{html:o.errorMsg},confirm:{html:"登录",click:function(){location.href=o.login}},cancel:{html:"取消",click:function(){a.close()}}},l={content:{html:o.errorMsg},confirm:{html:"关注",click:function(){window.showGuide&&window.showGuide("follow")}},cancel:{html:"取消",click:function(n){a.close()}}},r={content:{html:'每次抽奖将消耗<span class="important"> '+o.costPoint+"积分</span>"},confirm:{html:"赌一把",click:function(){a.close(),e.onconfirm&&e.onconfirm()}},cancel:{html:"舍不得",click:function(){a.close()}}};"/v2/apps/shake"==location.pathname&&(r.content.html='每次抽奖将消耗<span class="important"> '+o.costPoint+"积分，确定参加吗？</span>",r.confirm.html="我要参加",r.cancel.html="进店逛逛",r.cancel.click=function(){a.close(),location.href=_apps_global.home_page_url});var s={content:{html:o.errorMsg},confirm:{html:"知道了",click:function(){a.close()}},cancel:"remove"};return e={check:t,setCancelText:n,onconfirm:$.noop}}(),appUtils.atLeast=function(n,t){function e(){a.resolve.apply(null,arguments)}var o,i=!1,a={};return setTimeout(function(){i?t.apply(null,o):a.resolve=function(){t.apply(null,arguments)}},n),a.resolve=function(){o=arguments,i=!0},{resolve:e}},appUtils.randInt=function(n,t){var e=n+Math.random()*(t-n);return parseInt(e,10)},appUtils.format=function(n){var t=Array.prototype.slice.call(arguments,1);return n.replace(/{(\d+)}/g,function(n,e){return void 0!==t[e]?t[e]:n})},appUtils.getUrlParam=function(n,t){var e=new RegExp("(^|&)"+n+"=([^&]*)(&|$)"),o="router"===t?window.location.href:window.location.search,i=o.substr(1).match(e);return null!==i?window.unescape(i[2]):null},function(){function n(n){var t=Object.create(r);t.content={html:n},c.open(t)}function t(){return $._ajax({url:"/v2/apps/wheel/wheel.json",data:{alias:i.alias},cache:!1,type:"post",dataType:"json",timeout:5e3})}function e(){p.clear(),c.open(appUtils.preset.errorModal)}function o(){$(".js-start-btn").click(f),a.init=function(){}}var i=_apps_global,a={},c=appUtils.modal,l=appUtils.updateUrlWithStamp,r={content:{html:""},confirm:{html:"继续抽奖",click:function(){window.location.href=l(window.location.href)}},cancel:"remove"},s={content:{html:""},cancel:{html:"继续抽奖",click:function(){window.location.href=l(window.location.href)}},confirm:{html:"查看奖品",click:function(){window.location.href=_userCenterUrl}}},p=function(){function n(){s=0,m=!0,d=100,u=function(){},c()}function t(){f.get(s).removeClass("active"),s++,s>=f.length&&(s=0),f.get(s).addClass("active"),p=setTimeout(t,d),u()}function e(){m=!1,clearTimeout(p)}function o(){m||(n(),t())}function a(n,t){var o=2*f.length+(n-s);o>2*f.length&&(o-=f.length),u=function(){d*=1.08,0===--o&&(e(),t&&setTimeout(t,1400),f.getSelected().addClass("pulse"))}}function c(){$(".wheel-block").removeClass("active")}function l(){e(),c()}function r(n,t){a(f.selectByCategory(n),t)}var s,p,u,f,m=!1,d=100;f=function(){var n,t,e=[];return n={set:function(t,o){e[t]=o,n.length=e.length},get:function(n){return e[n]},selectByCategory:function(n){var o=e.filter(function(t){return t.hasClass(n)}),i=appUtils.randInt(0,o.length);return t=o[i].data("index")},getSelected:function(){return e[t]},length:0},n.splice=[].splice,n.constructor=Array,n}();var h=function(){var n={},t=function(n,t){n.addClass("animated tada"),setTimeout(function(){n.addClass("custom-icon").removeClass("animated tada").css("backgroundImage","url("+t+")")},1200)};return function(e,o){/!\d/.test(o)||(o+="!100x100.jpg");var i=function(){t(e,o)};if(n[o])i();else{n[o]=!0;var a=new Image;a.onload=i,a.src=o}}}();return $(".wheel-block").each(function(){var n=$(this),t=n.data("index");n.addClass("animated"),f.set(t,n)}),function(){var n,t,e,o,a=i.prize;for(n in a)t=a[n],e=$(".prize"+n).find(".wheel-icon"),o=t.image_url,o&&o.length>0?h(e,o):t.point>0?e.addClass("point-icon"):0===t.point&&e.addClass("coupon-icon")}(),{start:o,clear:l,to:r}}(),u=function(){var t=""===i.failedInfo?"哎呀，真可惜擦身而过!":i.failedInfo;return function(e){var o="";if(0===e.code){var a=e.data,l="";switch(a.type){case 0:l=a.point+" 个积分";break;case 1:l=a.value+"元 店铺优惠券";break;case 2:l=a.title}o=appUtils.format('<span class="important">哇！抽中 {0}！</span>',l),void 0!=a.give_point&&0!=a.give_point&&(o+=appUtils.format('<br>手气这么好，再送你 <span class="important">{0} 积分</span>',a.give_point)),p.to("prize"+a.level,function(){3==a.type&&(o=a.title,s.confirm.html="立即兑换",s.cancel="remove"),s.content.html=o,a.detail_url&&a.detail_url.length>0&&(s.confirm={html:"查看奖品",click:function(){window.location.href=a.detail_url}},$(".js-view-prize").attr("href",a.detail_url)),c.open(s)})}else 2==i.lotteryAgain?(o=e.msg||"运气不错，你还可以再玩一次",p.to("prize-again",function(){n(o)})):(o=t,p.to("prize-no",function(){n(o)})),void 0!=i.givePoint&&0!=i.givePoint&&(o+=appUtils.format('<br>送你 <span class="important">{0} 积分</span>',i.givePoint))}}(),f=function(){var n=!1;return function(){if(!n){n=!0,p.start();var o=appUtils.atLeast(1500,u),i=appUtils.atLeast(1500,e);t().done(o.resolve).fail(i.resolve)}}}();a.init=o,window.gameIns=a}(),$(function(){var n=$(".js-start-btn");appUtils.process.check()?gameIns.init():n.on("click",function(n){appUtils.process.check()}),appUtils.process.onconfirm=function(){n.unbind("click"),gameIns.init()},_apps_global.hasPoint||$(".js-activity-note").remove()},!1);