define("zenjs/uploader/photo_uploader",["require","bower_components/ajax/ajax","../util/ua"],function(e){e("bower_components/ajax/ajax");var t=e("../util/ua"),i=function(){},a=window._global,n=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},o=function(){var e="youzanwsc"===a.platform&&a.platform_version<="3.0.0";return!(t.getIOSVersion()>=9&&e)};return Backbone.View.extend({initialize:function(e){this.nInput=this.$("input"),this.nUploader=this.$("button"),this.save_to_shop=e.save_to_shop||!1,this.onValidUpload=e.onValidUpload||function(){return!0},this.onStartReadFile=e.onStartReadFile||i,this.onFinishReadFile=e.onFinishReadFile||i,this.onBeforeUpload=e.onBeforeUpload||i,this.onUploadSuccess=e.onUploadSuccess||i,this.onUploadError=e.onUploadError||i,this.onGetToken=e.onGetToken},events:{"click input":"onInputClicked","change input":"onFileChanged"},render:function(e){n()||(this.nInput.attr("disabled","disabled"),this.nUploader.css("padding-left","10px").html("您的浏览器不支持图片上传").attr("disabled","disabled")),o()||this.nInput.on("click",function(e){e.preventDefault(),motify.log("暂不支持图片上传功能")})},onInputClicked:function(e){e.target.value=""},onFileChanged:function(e){var t=this,i=e.target.files;_.map(i,function(e,i,a){if(e.size>5242880)return void motify.log("图片太大啦~");if(t.onValidUpload({file:e})){t.onStartReadFile({file:e});var n=new FileReader;n.onload=function(i){t.onFinishReadFile({src:i.target.result,file:e})},n.readAsDataURL(e),t.getUploadToken(e)}})},getUploadToken:function(e){var t=this;if(this.uptoken)return void this.doUploadPhoto(e);var i=function(i){t.uptoken=i,t.doUploadPhoto(e)},a=function(){motify.log("上传图片失败，请重试")};if(this.onGetToken&&"function"==typeof this.onGetToken)return void this.onGetToken(i,a);var n=window._global.url.wap+"/materials/storage/pubImgUploadToken.json";"https:"===location.protocol&&(n=n.replace("http://","https://")),$._ajax({url:n,type:"post",dataType:"json",timeout:5e3,cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){},success:function(e){i(e.data.uptoken)},error:function(e,t,i){a()},complete:function(e,t){}})},doUploadPhoto:function(e){var t=this,i=new FormData;i.append("token",this.uptoken),i.append("file",e),this.save_to_shop===!1&&i.append("x:skip_save",1);var n=e.name.split("."),o="";n.length>1&&(o="."+n[n.length-1]),i.append("x:ext",o),$._ajax({url:"//up.qbox.me",type:"post",data:i,dataType:"json",processData:!1,contentType:!1,timeout:8e4,beforeSend:function(){t.onBeforeUpload({file:e}),t.nInput.data("uploaded","false"),t.trigger("data_change"),t.trigger("data_change:start")},success:function(i){var n=a.url.imgqn+"/"+i.data.attachment_file;t.onUploadSuccess({url:n,file:e,data:i.data}),t.nInput.data("value",n),t.nInput.data("uploaded","true"),t.trigger("data_change"),t.trigger("data_change:success",{url:n})},error:function(i,a,n){t.onUploadError({file:e}),"timeout"===a&&motify.log("网络环境不佳<br/>请稍后重试")},complete:function(e,t){}})}})}),define("zenjs/multi_uploader/model",[],function(){return Backbone.Model.extend({initialize:function(e){e=e||{},this.max_picture_num=e.max_picture_num||5,this.uploadFiles={},this.uploadingList=[]},validItem:function(e){return this.uploadFiles[e]?(motify.log("该图片已经上传过了~"),!1):this.countItem()>this.max_picture_num-1?(motify.log("最多只能上传"+this.max_picture_num+"张图片"),!1):(this.addItem(e),!0)},getAllPhoto:function(){return _.filter(_.pluck(this.uploadFiles,"url"),function(e){return!!e})},getFullData:function(){return _.pluck(this.uploadFiles,"fullData")},isFinishLoading:function(){return!this.uploadingList.length},startUploading:function(e,t){this.uploadingList.push(e)},finishUploading:function(e){var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},getItem:function(e){return(this.uploadFiles[e]||{}).el},updateItem:function(e,t){this.uploadFiles[e]&&_.extend(this.uploadFiles[e],t||{})},addItem:function(e,t,i){this.uploadFiles[e]=this.uploadFiles[e]||{},this.uploadFiles[e].el=t,this.uploadFiles[e].url=i},removeItem:function(e){delete this.uploadFiles[e];var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},countItem:function(){return _.size(this.uploadFiles)}})}),define("text!zenjs/multi_uploader/templates/upload_image.html",[],function(){return"<span class=\"picture-wrapper\">\n\t<i class='js-delete-picture delete-picture' data-key='<%= data.key %>'></i>\n\t<img src='<%= data.src %>' alt=''>\n</span>\n"}),define("zenjs/util/number",[],function(){return{makeRandomString:function(e){var t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var a=0;a<e;a++)t+=i.charAt(Math.floor(Math.random()*i.length));return t}}}),define("zenjs/multi_uploader/main",["require","../uploader/photo_uploader","./model","text!./templates/upload_image.html","../util/number"],function(e){var t=e("../uploader/photo_uploader"),i=e("./model"),a=e("text!./templates/upload_image.html"),n=e("../util/number"),o=_.template(a),r=function(){};return Backbone.View.extend({initialize:function(e){var a=this;this.files=e.files||[],this.max_picture_num=e.max_picture_num||5,this.onUploadStart=e.onUploadStart||r,this.onUploadSuccess=e.onUploadSuccess||r,this.onUploadError=e.onUploadError||r,this.onAddImageBtnShow=e.onAddImageBtnShow||r,this.onAddImageBtnHide=e.onAddImageBtnHide||r,this.nAddImage=this.$(".js-add-picture"),this.model=e.model||new i({max_picture_num:this.max_picture_num}),this.photoUploader=new t({el:this.el,skip_save:e.save_to_shop||!1,onStartReadFile:function(e){var t=a.generatekey(e);a.model.addItem(t);var i=a.addSingleItem({src:"",key:t});i.addClass("loading"),a.refreshAddImageBtn(),a.model.addItem(t,i),a.model.startUploading(t),a.onUploadStart(e,t,i),a.trigger("data_change"),a.trigger("data_change:start")},onFinishReadFile:function(e){var t=a.generatekey(e);a.model.getItem(t).find("img").attr("src",e.src)},onUploadSuccess:function(e){var t=a.generatekey(e),i=a.model.getItem(t);i&&(i.removeClass("loading"),a.model.finishUploading(t),a.model.updateItem(t,{url:e.url,fullData:e.data}),i.find("img").attr("src",e.url+"!100x100.jpg"),i.find("img").data("src",e.url),a.onUploadSuccess(e,t,i),a.trigger("data_change"),a.trigger("data_change:success"))},onUploadError:function(e){var t=a.generatekey(e),i=a.removeSingleItem(t);a.onUploadError(e,t,i),a.trigger("data_change"),a.trigger("data_change:remove")},onValidUpload:function(e){var t=e.file.name+"_"+e.file.size;return a.model.validItem(t)}})},render:function(){var e=this;return _.map(this.files,function(t,i,a){var i=e.generatekey(),n=e.addSingleItem({src:t,key:i});e.model.addItem(i,n,t)}),this.refreshAddImageBtn(),this.photoUploader.render(),this},events:{"click .delete-picture":"deletePicture"},generatekey:function(e){return e?e.file.name+"_"+e.file.size:(new Date).getTime()+n.makeRandomString()},deletePicture:function(e){var t=$(e.target).data("key");this.removeSingleItem(t),this.trigger("data_change"),this.trigger("data_change:remove")},removeSingleItem:function(e){var t=this.model.getItem(e);return t.remove(),this.model.removeItem(e),this.refreshAddImageBtn(),t},addSingleItem:function(e){var t=$(o({data:e}));return this.nAddImage.before(t),t},refreshAddImageBtn:function(){this.model.countItem()>this.max_picture_num-1?(this.nAddImage.hide(),this.onAddImageBtnHide()):(this.nAddImage.show(),this.onAddImageBtnShow())},getPhotos:function(){var e=this.model.getAllPhoto();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},getFullData:function(){var e=this.model.getFullData();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},countItem:function(){return this.model.countItem()}})}),define("wap/trade/reviews/review_form/model",[],function(){var e=function(){};return Backbone.Model.extend({defaults:{rate:0,desc_rate:0,serv_rate:0,logi_rate:0,photos:[],review:""},isValid:function(){var e=this.toJSON();return 0==e.rate?void motify.log("请选择总体感受"):e.review.length>500?void motify.log("评论太长啦"):[10,20,30].indexOf(e.rate)<0?void motify.log("总体感受评分错误"):e.desc_rate<0||e.desc_rate>5?void motify.log("商品描述评分错误"):e.serv_rate<0||e.serv_rate>5?void motify.log("卖家服务评分错误"):!(e.logi_rate<0||e.logi_rate>5)||void motify.log("物流发货评分错误")},ajax:function(t){if(!this.ajaxing){var i=this;this.ajaxing=!0,$._ajax({url:"/v2/trade/reviews/reviews.json",type:"POST",dataType:"json",data:$.extend({},t.externalData,this.toJSON()),beforeSend:function(){(t.beforeSend||e)()},success:function(i){(t.success||e)(i)},complete:function(){(t.complete||e)(),i.ajaxing=!1}})}}})}),require(["zenjs/multi_uploader/main","wap/trade/reviews/review_form/model"],function(e,t){var i=Backbone.View.extend({initialize:function(i){this.model=new t,this.photoView=new e({el:this.$(".js-input-container"),files:[],max_picture_num:6}),this.postExternalData={order_no:i._global.order_no,goods_id:i._global.goods_id,sku_id:i._global.sku_id,alias:i._global.alias}},events:{"click .js-review-level":"onLevelClick","click .js-star":"onStarClick","click .js-submit":"onSubmit","click .js-share-check-response":"onShareCheckClick"},render:function(e){return this.photoView.render(),this},onLevelClick:function(e){var t=$(e.target),i=+t.data("level");$(".js-review-level.active").removeClass("active"),this.model.set("rate",i),t.addClass("active")},onStarClick:function(e){var t=$(e.target);t.hasClass("js-star")||(t=t.parents(".js-star"));var i=t.parents(".js-rs-item-star"),a=i.find(".js-star"),n=t.data("star"),o=i.data("type");["desc_rate","serv_rate","logi_rate"].indexOf(o)<0||(this.model.set(o,n),a.removeClass("active"),a.each(function(e,t){e<n&&$(t).addClass("active")}))},onShareCheckClick:function(e){$(e.target).parent().find(".js-share-check").toggleClass("active")},onSubmit:function(e){var t=this,i=$(e.target),a=this.photoView.getPhotos();if(0!=a.status)return void motify.log(a.msg);var n=a.data;this.model.set("photos",n),this.model.set("review",this.$(".js-review-text").val()),this.model.isValid()&&this.model.ajax({externalData:this.postExternalData,beforeSend:function(){i.attr("disabled","disabled")},success:function(e){var i=e.code,a=e.data||{};if(10020==i)return motify.log(e.msg,4e3),void t.replaceSensitiveWorld(a);if(0!=i)return void motify.log(e.msg);var n=a.reviews_alias,o=t.$(".js-share-check").hasClass("active");motify.log("评价提交成功<br>页面跳转中..."),setTimeout(function(){location.href=window._global.wap_url.wap+"/trade/reviews/oneReview?alias="+n+"&review_share_type="+(o?"1":"0")},2e3)},error:function(){},complete:function(){i.removeAttr("disabled")}})},replaceSensitiveWorld:function(e){var t=this.$(".js-review-text"),i=t.val(),a=new RegExp(e.join("|"),"g"),i=i.replace(a,function(e){for(var t="",i=0;i<e.length;i++)t+="*";return t});t.val(i)}});window.app=new i({el:$("body"),_global:window._global}).render()}),define("main",function(){});