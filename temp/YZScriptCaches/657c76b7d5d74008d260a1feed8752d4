window.Utils=window.Utils||{},$.extend(window.Utils,{validMobile:function(e){return e=""+e,/^((\+86)|(86))?(1)\d{10}$/.test(e)},validPhone:function(e){return e=""+e,/^0[0-9\-]{10,13}$/.test(e)},validNumber:function(e){return/^\d+$/.test(e)},validHKPhone:function(e){return/^(5|6|8|9)\d{7}$/.test(e+"")},validTWPhone:function(e){return/^09\d{2}-?\d{3}-?\d{3}$/.test(e+"")},validEmail:function(e){return/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(e)},validPostalCode:function(e){return e=""+e,/^\d{6}$/.test(e)}}),define("wap/components/util/valid",function(){}),define("wap/trade/safe/apply/model/model",["require","wap/components/util/valid"],function(e){return e("wap/components/util/valid"),Backbone.Model.extend({url:function(){return this.safe_no?"/v2/trade/safe/applyModify.json":"/v2/trade/safe/apply.json"},initialize:function(){this.set("order_no",window._global.order_no),this.set("item_id",window._global.item_id),this.set("is_luckmoney",window._global.is_luckmoney),this.safe_no=(window._global.safe_info||[]).safe_no,this.safe_no&&this.set("safe_no",this.safe_no),this.max_money=parseFloat(window._global.real_pay)},ajax:function(e){if(this.validate(this.toJSON())){$._ajax(_.extend({url:this.url(),type:"POST",dataType:"json",data:this.toJSON()},e||{}))}},validate:function(e){if(e=e||{},!e.safe_type)return void motify.log("请选择处理方式");if(!e.reason)return void motify.log("请选择退款原因");var t=e.refund_fee;return!t||t<=0||t>this.max_money||!/^\d+(\.\d+)*$/.test(t)?void motify.log("请填写正确的退款金额"):window.Utils.validPhone(e.phone)||window.Utils.validMobile(e.phone)?!(e.remark.length>200)||void motify.log("备注信息不能超过200字"):void motify.log("请填写正确的手机号码")}})}),define("zenjs/uploader/photo_uploader",["require","bower_components/ajax/ajax","../util/ua"],function(e){e("bower_components/ajax/ajax");var t=e("../util/ua"),n=function(){},i=window._global,o=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},a=function(){var e="youzanwsc"===i.platform&&i.platform_version<="3.0.0";return!(t.getIOSVersion()>=9&&e)};return Backbone.View.extend({initialize:function(e){this.nInput=this.$("input"),this.nUploader=this.$("button"),this.save_to_shop=e.save_to_shop||!1,this.onValidUpload=e.onValidUpload||function(){return!0},this.onStartReadFile=e.onStartReadFile||n,this.onFinishReadFile=e.onFinishReadFile||n,this.onBeforeUpload=e.onBeforeUpload||n,this.onUploadSuccess=e.onUploadSuccess||n,this.onUploadError=e.onUploadError||n,this.onGetToken=e.onGetToken},events:{"click input":"onInputClicked","change input":"onFileChanged"},render:function(e){o()||(this.nInput.attr("disabled","disabled"),this.nUploader.css("padding-left","10px").html("您的浏览器不支持图片上传").attr("disabled","disabled")),a()||this.nInput.on("click",function(e){e.preventDefault(),motify.log("暂不支持图片上传功能")})},onInputClicked:function(e){e.target.value=""},onFileChanged:function(e){var t=this,n=e.target.files;_.map(n,function(e,n,i){if(e.size>5242880)return void motify.log("图片太大啦~");if(t.onValidUpload({file:e})){t.onStartReadFile({file:e});var o=new FileReader;o.onload=function(n){t.onFinishReadFile({src:n.target.result,file:e})},o.readAsDataURL(e),t.getUploadToken(e)}})},getUploadToken:function(e){var t=this;if(this.uptoken)return void this.doUploadPhoto(e);var n=function(n){t.uptoken=n,t.doUploadPhoto(e)},i=function(){motify.log("上传图片失败，请重试")};if(this.onGetToken&&"function"==typeof this.onGetToken)return void this.onGetToken(n,i);var o=window._global.url.wap+"/materials/storage/pubImgUploadToken.json";"https:"===location.protocol&&(o=o.replace("http://","https://")),$._ajax({url:o,type:"post",dataType:"json",timeout:5e3,cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){},success:function(e){n(e.data.uptoken)},error:function(e,t,n){i()},complete:function(e,t){}})},doUploadPhoto:function(e){var t=this,n=new FormData;n.append("token",this.uptoken),n.append("file",e),this.save_to_shop===!1&&n.append("x:skip_save",1);var o=e.name.split("."),a="";o.length>1&&(a="."+o[o.length-1]),n.append("x:ext",a),$._ajax({url:"//up.qbox.me",type:"post",data:n,dataType:"json",processData:!1,contentType:!1,timeout:8e4,beforeSend:function(){t.onBeforeUpload({file:e}),t.nInput.data("uploaded","false"),t.trigger("data_change"),t.trigger("data_change:start")},success:function(n){var o=i.url.imgqn+"/"+n.data.attachment_file;t.onUploadSuccess({url:o,file:e,data:n.data}),t.nInput.data("value",o),t.nInput.data("uploaded","true"),t.trigger("data_change"),t.trigger("data_change:success",{url:o})},error:function(n,i,o){t.onUploadError({file:e}),"timeout"===i&&motify.log("网络环境不佳<br/>请稍后重试")},complete:function(e,t){}})}})}),define("zenjs/multi_uploader/model",[],function(){return Backbone.Model.extend({initialize:function(e){e=e||{},this.max_picture_num=e.max_picture_num||5,this.uploadFiles={},this.uploadingList=[]},validItem:function(e){return this.uploadFiles[e]?(motify.log("该图片已经上传过了~"),!1):this.countItem()>this.max_picture_num-1?(motify.log("最多只能上传"+this.max_picture_num+"张图片"),!1):(this.addItem(e),!0)},getAllPhoto:function(){return _.filter(_.pluck(this.uploadFiles,"url"),function(e){return!!e})},getFullData:function(){return _.pluck(this.uploadFiles,"fullData")},isFinishLoading:function(){return!this.uploadingList.length},startUploading:function(e,t){this.uploadingList.push(e)},finishUploading:function(e){var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},getItem:function(e){return(this.uploadFiles[e]||{}).el},updateItem:function(e,t){this.uploadFiles[e]&&_.extend(this.uploadFiles[e],t||{})},addItem:function(e,t,n){this.uploadFiles[e]=this.uploadFiles[e]||{},this.uploadFiles[e].el=t,this.uploadFiles[e].url=n},removeItem:function(e){delete this.uploadFiles[e];var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},countItem:function(){return _.size(this.uploadFiles)}})}),define("text!zenjs/multi_uploader/templates/upload_image.html",[],function(){return"<span class=\"picture-wrapper\">\n\t<i class='js-delete-picture delete-picture' data-key='<%= data.key %>'></i>\n\t<img src='<%= data.src %>' alt=''>\n</span>\n"}),define("zenjs/util/number",[],function(){return{makeRandomString:function(e){var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}}}),define("zenjs/multi_uploader/main",["require","../uploader/photo_uploader","./model","text!./templates/upload_image.html","../util/number"],function(e){var t=e("../uploader/photo_uploader"),n=e("./model"),i=e("text!./templates/upload_image.html"),o=e("../util/number"),a=_.template(i),s=function(){};return Backbone.View.extend({initialize:function(e){var i=this;this.files=e.files||[],this.max_picture_num=e.max_picture_num||5,this.onUploadStart=e.onUploadStart||s,this.onUploadSuccess=e.onUploadSuccess||s,this.onUploadError=e.onUploadError||s,this.onAddImageBtnShow=e.onAddImageBtnShow||s,this.onAddImageBtnHide=e.onAddImageBtnHide||s,this.nAddImage=this.$(".js-add-picture"),this.model=e.model||new n({max_picture_num:this.max_picture_num}),this.photoUploader=new t({el:this.el,skip_save:e.save_to_shop||!1,onStartReadFile:function(e){var t=i.generatekey(e);i.model.addItem(t);var n=i.addSingleItem({src:"",key:t});n.addClass("loading"),i.refreshAddImageBtn(),i.model.addItem(t,n),i.model.startUploading(t),i.onUploadStart(e,t,n),i.trigger("data_change"),i.trigger("data_change:start")},onFinishReadFile:function(e){var t=i.generatekey(e);i.model.getItem(t).find("img").attr("src",e.src)},onUploadSuccess:function(e){var t=i.generatekey(e),n=i.model.getItem(t);n&&(n.removeClass("loading"),i.model.finishUploading(t),i.model.updateItem(t,{url:e.url,fullData:e.data}),n.find("img").attr("src",e.url+"!100x100.jpg"),n.find("img").data("src",e.url),i.onUploadSuccess(e,t,n),i.trigger("data_change"),i.trigger("data_change:success"))},onUploadError:function(e){var t=i.generatekey(e),n=i.removeSingleItem(t);i.onUploadError(e,t,n),i.trigger("data_change"),i.trigger("data_change:remove")},onValidUpload:function(e){var t=e.file.name+"_"+e.file.size;return i.model.validItem(t)}})},render:function(){var e=this;return _.map(this.files,function(t,n,i){var n=e.generatekey(),o=e.addSingleItem({src:t,key:n});e.model.addItem(n,o,t)}),this.refreshAddImageBtn(),this.photoUploader.render(),this},events:{"click .delete-picture":"deletePicture"},generatekey:function(e){return e?e.file.name+"_"+e.file.size:(new Date).getTime()+o.makeRandomString()},deletePicture:function(e){var t=$(e.target).data("key");this.removeSingleItem(t),this.trigger("data_change"),this.trigger("data_change:remove")},removeSingleItem:function(e){var t=this.model.getItem(e);return t.remove(),this.model.removeItem(e),this.refreshAddImageBtn(),t},addSingleItem:function(e){var t=$(a({data:e}));return this.nAddImage.before(t),t},refreshAddImageBtn:function(){this.model.countItem()>this.max_picture_num-1?(this.nAddImage.hide(),this.onAddImageBtnHide()):(this.nAddImage.show(),this.onAddImageBtnShow())},getPhotos:function(){var e=this.model.getAllPhoto();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},getFullData:function(){var e=this.model.getFullData();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},countItem:function(){return this.model.countItem()}})}),window.Zepto&&function(e){e.fn.serializeArray=function(){var t,n,i=[],o=function(e){if(e.forEach)return e.forEach(o);i.push({name:t,value:e})};return this[0]&&e.each(this[0].elements,function(i,a){n=a.type,t=a.name,t&&"fieldset"!=a.nodeName.toLowerCase()&&!a.disabled&&"submit"!=n&&"reset"!=n&&"button"!=n&&"file"!=n&&("radio"!=n&&"checkbox"!=n||a.checked)&&o(e(a).val())}),i},e.fn.serialize=function(){var e=[];return this.serializeArray().forEach(function(t){e.push(encodeURIComponent(t.name)+"="+encodeURIComponent(t.value))}),e.join("&")},e.fn.submit=function(t){if(0 in arguments)this.bind("submit",t);else if(this.length){var n=e.Event("submit");this.eq(0).trigger(n),n.isDefaultPrevented()||this.get(0).submit()}return this}}(Zepto),define("vendor/zepto/form",function(){}),window.Utils=window.Utils||{},define("wap/components/util/form",["vendor/zepto/form"],function(e){window.Utils.getFormData=function(e){var t=e.serializeArray(),n={};return $.map(t,function(e){n[e.name]=e.value}),n}}),define("text!wap/trade/safe/apply/templates/reason_select.html",[],function(){return'<option value="">请选择退款原因</option>\n<% _.each(reasons, function(val, index) { %>\n\t<option value="<%= index %>"><%= val || \'\' %></option>\n<% }) %>'}),require(["wap/trade/safe/apply/model/model","zenjs/multi_uploader/main","wap/components/util/form","text!wap/trade/safe/apply/templates/reason_select.html"],function(e,t,n,i){var o=_.template(i),a=window._global||{},s=Backbone.View.extend({initialize:function(e){this._global=e._global,this.nInputContainer=this.$(".js-input-container"),this.photoView=new t({el:this.nInputContainer,files:this._global.safe_info.ext_info||[]}),this.nMethod=this.$(".js-method"),this.nExpress=this.$(".js-express"),this.nReason=this.$(".js-reason"),this.nExpressBlock=this.$(".js-express-block"),this.changeSelect("method")},events:{"click .js-submit":"submitComplaint","focus .js-message":"focusMessage","blur .js-message":"blurMessage","blur .js-money":"blurMoney","change .js-method":"onMethodChange","change .js-express":"onExpressChange"},render:function(e){return this.photoView.render(),"ios"!=window._global.mobile_system||window.__wxjs_is_wkwebview||this.$("select").on("touchend",function(e){e.preventDefault()}),this},changeSelect:function(e){switch(e){case"method":this.safe_type=this.nMethod.val(),this.switchSafeType();case"express":this.express=this.nExpress.val(),this.switchExpress();default:this.renderReasonSelect()}},onMethodChange:function(){this.changeSelect("method")},onExpressChange:function(){this.changeSelect("express")},switchSafeType:function(){if(this.safe_type&&2!=this.safe_type?this.nExpressBlock.removeClass("hide"):this.nExpressBlock.addClass("hide"),this.safe_type){var e=1==this.safe_type?"refund":"refund_and_return";this.reasonRelation=window._global.reason_relation[e]}},switchExpress:function(){return this.safe_type?2==this.safe_type?void(this.reasonItems=this.reasonRelation||{}):this.express<0?void(this.reasonItems={}):void(this.reasonItems=this.reasonRelation[this.express]||{}):void(this.reasonItems={})},renderReasonSelect:function(){this.nReason.html(o({reasons:this.reasonItems}))},submitComplaint:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),n=this.photoView.getPhotos()||{};if(0!=n.status)return void motify.log(n.msg);var i=n.data||[];this.model.set("photos",i);var o=window.Utils.getFormData($(".js-apply-form"));a.is_full_refund?o.refund_fee=a.safe_info.refund_fee||a.real_pay:o.refund_fee=this.$(".js-money").val(),this.model.set(o),this.model.ajax({beforeSend:function(){t.prop("disabled","disabled")},success:function(e,n,i){var o=e.code,a=e.msg;e.data;0==o?(motify.log("申请成功，页面跳转中",2e3),setTimeout(function(){window.location.href=this._global.url.trade+"/v2/trade/safe/info?order_no="+this._global.order_no+"&item_id="+this._global.item_id},1e3)):(motify.log(a),t.removeAttr("disabled"))},error:function(e,n,i){motify.log("数据提交失败，请重试一下"),t.removeAttr("disabled")},complete:function(){}})},focusMessage:function(e){$(e.target).addClass("active")},blurMessage:function(e){$(e.target).removeClass("active")},blurMoney:function(e){var t=($(e.target),$(".js-money").val());return""===t?void $(".js-luluckmoney-region").addClass("hide"):parseFloat(t,10)>parseFloat(window._global.real_pay,10)?void motify.log("退款金额不能超过"+window._global.real_pay+"元"):void(1===Number(window._global.is_luckmoney)&&$._ajax({url:"/v2/trade/safe/luckMoney.json",type:"POST",data:{order_no:window._global.order_no,item_id:window._global.item_id,refund_fee:t,kdt_id:window._global.kdt_id},success:function(e){if(0===e.code){$(".js-luluckmoney-region").removeClass("hide");var t=Number(e.data.luckmoney),n=Number(e.data.real_refund_fee);$(".js-luckmoney-money").html(t),$(".js-real-money").html(n)}else motify.log(e.msg),$(".js-luluckmoney-region").addClass("hide")},error:function(){motify.log("网络错误，请重试一下"),$(".js-luluckmoney-region").addClass("hide")}}))}});window.app=new s({_global:window._global,model:new e,el:$("body")}).render()}),define("main",function(){});