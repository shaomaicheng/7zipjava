define("zenjs/uploader/photo_uploader",["require","bower_components/ajax/ajax","../util/ua"],function(e){e("bower_components/ajax/ajax");var t=e("../util/ua"),o=function(){},a=window._global,i=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var e=document.createElement("input");return e.type="file",!e.disabled},n=function(){var e="youzanwsc"===a.platform&&a.platform_version<="3.0.0";return!(t.getIOSVersion()>=9&&e)};return Backbone.View.extend({initialize:function(e){this.nInput=this.$("input"),this.nUploader=this.$("button"),this.save_to_shop=e.save_to_shop||!1,this.onValidUpload=e.onValidUpload||function(){return!0},this.onStartReadFile=e.onStartReadFile||o,this.onFinishReadFile=e.onFinishReadFile||o,this.onBeforeUpload=e.onBeforeUpload||o,this.onUploadSuccess=e.onUploadSuccess||o,this.onUploadError=e.onUploadError||o,this.onGetToken=e.onGetToken},events:{"click input":"onInputClicked","change input":"onFileChanged"},render:function(e){i()||(this.nInput.attr("disabled","disabled"),this.nUploader.css("padding-left","10px").html("您的浏览器不支持图片上传").attr("disabled","disabled")),n()||this.nInput.on("click",function(e){e.preventDefault(),motify.log("暂不支持图片上传功能")})},onInputClicked:function(e){e.target.value=""},onFileChanged:function(e){var t=this,o=e.target.files;_.map(o,function(e,o,a){if(e.size>5242880)return void motify.log("图片太大啦~");if(t.onValidUpload({file:e})){t.onStartReadFile({file:e});var i=new FileReader;i.onload=function(o){t.onFinishReadFile({src:o.target.result,file:e})},i.readAsDataURL(e),t.getUploadToken(e)}})},getUploadToken:function(e){var t=this;if(this.uptoken)return void this.doUploadPhoto(e);var o=function(o){t.uptoken=o,t.doUploadPhoto(e)},a=function(){motify.log("上传图片失败，请重试")};if(this.onGetToken&&"function"==typeof this.onGetToken)return void this.onGetToken(o,a);var i=window._global.url.wap+"/materials/storage/pubImgUploadToken.json";"https:"===location.protocol&&(i=i.replace("http://","https://")),$._ajax({url:i,type:"post",dataType:"json",timeout:5e3,cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){},success:function(e){o(e.data.uptoken)},error:function(e,t,o){a()},complete:function(e,t){}})},doUploadPhoto:function(e){var t=this,o=new FormData;o.append("token",this.uptoken),o.append("file",e),this.save_to_shop===!1&&o.append("x:skip_save",1);var i=e.name.split("."),n="";i.length>1&&(n="."+i[i.length-1]),o.append("x:ext",n),$._ajax({url:"//up.qbox.me",type:"post",data:o,dataType:"json",processData:!1,contentType:!1,timeout:8e4,beforeSend:function(){t.onBeforeUpload({file:e}),t.nInput.data("uploaded","false"),t.trigger("data_change"),t.trigger("data_change:start")},success:function(o){var i=a.url.imgqn+"/"+o.data.attachment_file;t.onUploadSuccess({url:i,file:e,data:o.data}),t.nInput.data("value",i),t.nInput.data("uploaded","true"),t.trigger("data_change"),t.trigger("data_change:success",{url:i})},error:function(o,a,i){t.onUploadError({file:e}),"timeout"===a&&motify.log("网络环境不佳<br/>请稍后重试")},complete:function(e,t){}})}})}),define("zenjs/multi_uploader/model",[],function(){return Backbone.Model.extend({initialize:function(e){e=e||{},this.max_picture_num=e.max_picture_num||5,this.uploadFiles={},this.uploadingList=[]},validItem:function(e){return this.uploadFiles[e]?(motify.log("该图片已经上传过了~"),!1):this.countItem()>this.max_picture_num-1?(motify.log("最多只能上传"+this.max_picture_num+"张图片"),!1):(this.addItem(e),!0)},getAllPhoto:function(){return _.filter(_.pluck(this.uploadFiles,"url"),function(e){return!!e})},getFullData:function(){return _.pluck(this.uploadFiles,"fullData")},isFinishLoading:function(){return!this.uploadingList.length},startUploading:function(e,t){this.uploadingList.push(e)},finishUploading:function(e){var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},getItem:function(e){return(this.uploadFiles[e]||{}).el},updateItem:function(e,t){this.uploadFiles[e]&&_.extend(this.uploadFiles[e],t||{})},addItem:function(e,t,o){this.uploadFiles[e]=this.uploadFiles[e]||{},this.uploadFiles[e].el=t,this.uploadFiles[e].url=o},removeItem:function(e){delete this.uploadFiles[e];var t=this.uploadingList.indexOf(e);t>-1&&this.uploadingList.splice(t,1)},countItem:function(){return _.size(this.uploadFiles)}})}),define("text!zenjs/multi_uploader/templates/upload_image.html",[],function(){return"<span class=\"picture-wrapper\">\n\t<i class='js-delete-picture delete-picture' data-key='<%= data.key %>'></i>\n\t<img src='<%= data.src %>' alt=''>\n</span>\n"}),define("zenjs/util/number",[],function(){return{makeRandomString:function(e){var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";e=e||10;for(var a=0;a<e;a++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}}}),define("zenjs/multi_uploader/main",["require","../uploader/photo_uploader","./model","text!./templates/upload_image.html","../util/number"],function(e){var t=e("../uploader/photo_uploader"),o=e("./model"),a=e("text!./templates/upload_image.html"),i=e("../util/number"),n=_.template(a),l=function(){};return Backbone.View.extend({initialize:function(e){var a=this;this.files=e.files||[],this.max_picture_num=e.max_picture_num||5,this.onUploadStart=e.onUploadStart||l,this.onUploadSuccess=e.onUploadSuccess||l,this.onUploadError=e.onUploadError||l,this.onAddImageBtnShow=e.onAddImageBtnShow||l,this.onAddImageBtnHide=e.onAddImageBtnHide||l,this.nAddImage=this.$(".js-add-picture"),this.model=e.model||new o({max_picture_num:this.max_picture_num}),this.photoUploader=new t({el:this.el,skip_save:e.save_to_shop||!1,onStartReadFile:function(e){var t=a.generatekey(e);a.model.addItem(t);var o=a.addSingleItem({src:"",key:t});o.addClass("loading"),a.refreshAddImageBtn(),a.model.addItem(t,o),a.model.startUploading(t),a.onUploadStart(e,t,o),a.trigger("data_change"),a.trigger("data_change:start")},onFinishReadFile:function(e){var t=a.generatekey(e);a.model.getItem(t).find("img").attr("src",e.src)},onUploadSuccess:function(e){var t=a.generatekey(e),o=a.model.getItem(t);o&&(o.removeClass("loading"),a.model.finishUploading(t),a.model.updateItem(t,{url:e.url,fullData:e.data}),o.find("img").attr("src",e.url+"!100x100.jpg"),o.find("img").data("src",e.url),a.onUploadSuccess(e,t,o),a.trigger("data_change"),a.trigger("data_change:success"))},onUploadError:function(e){var t=a.generatekey(e),o=a.removeSingleItem(t);a.onUploadError(e,t,o),a.trigger("data_change"),a.trigger("data_change:remove")},onValidUpload:function(e){var t=e.file.name+"_"+e.file.size;return a.model.validItem(t)}})},render:function(){var e=this;return _.map(this.files,function(t,o,a){var o=e.generatekey(),i=e.addSingleItem({src:t,key:o});e.model.addItem(o,i,t)}),this.refreshAddImageBtn(),this.photoUploader.render(),this},events:{"click .delete-picture":"deletePicture"},generatekey:function(e){return e?e.file.name+"_"+e.file.size:(new Date).getTime()+i.makeRandomString()},deletePicture:function(e){var t=$(e.target).data("key");this.removeSingleItem(t),this.trigger("data_change"),this.trigger("data_change:remove")},removeSingleItem:function(e){var t=this.model.getItem(e);return t.remove(),this.model.removeItem(e),this.refreshAddImageBtn(),t},addSingleItem:function(e){var t=$(n({data:e}));return this.nAddImage.before(t),t},refreshAddImageBtn:function(){this.model.countItem()>this.max_picture_num-1?(this.nAddImage.hide(),this.onAddImageBtnHide()):(this.nAddImage.show(),this.onAddImageBtnShow())},getPhotos:function(){var e=this.model.getAllPhoto();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},getFullData:function(){var e=this.model.getFullData();return this.model.isFinishLoading()?{status:0,msg:"",data:e}:{status:102,msg:"图片正在上传中，请稍等",data:e}},countItem:function(){return this.model.countItem()}})}),define("wap/components/app_h5/main",["require","exports","module"],function(e,t,o){o.exports={currentUrl:"",currentTime:Date.now(),doCall:function(e,t){window.onReady("YouzanJSBridge",function(){window.YouzanJSBridge.doCall(e,t)})},compareVersion:function(e,t){for(e=e.split(".").join(""),t=t.split(".").join("");e.length!==t.length;)e.length>t.length?t+="0":e+="0";return e=Number(e),t=Number(t),e>t?"gt":e===t?"eq":"lt"},eq:function(e,t){return"eq"===this.compareVersion(e,t)},gte:function(e,t){var o=this.compareVersion(e,t);return"eq"===o||"gt"===o},lte:function(e,t){var o=this.compareVersion(e,t);return"eq"===o||"lt"===o},configNative:function(e){this.doCall("configNative",e)},getData:function(e,t){t.datatype=e,this.doCall("getData",t)},putData:function(e,t){if("youzanwxd"===_global.platform)if(this.gte(_global.platform_version,"1.5.0"))t.datatype=e,this.doCall("putData",t);else switch(e){case"supplierInfo":this.doCall("tellSupplierInfo",{supplier_kdt_id:t.supplier_kdt_id});break;case"goodsInfo":this.doCall("tellGoodsInfo",{goods_id:t.goods_id})}else t.datatype=e,this.doCall("putData",t)},gotoWebview:function(e){if(this.currentUrl===e.url&&Date.now()-this.currentTime<100)this.currentTime=Date.now();else if(this.currentUrl=e.url,this.currentTime=Date.now(),"youzanwxd"===_global.platform)if(this.gte(_global.platform_version,"1.5.0"))this.doCall("gotoWebview",e);else switch(e.page){case"supplierHomepage":this.doCall("goHomePage",{homeurl:e.url,name:e.name});break;case"goodsList":this.doCall("viewGoodsList",{url:e.url});break;case"goodsDetail":this.doCall("viewGoodsDetail",{detail_url:e.url,average_profit:e.average_profit,alias:e.alias,seller_goods_alias:e.seller_goods_alias});break;case"newsDetail":this.doCall("viewNewsDetail",{detail_url:e.url})}else this.doCall("gotoWebview",e)},gotoNative:function(e){if("youzanwxd"===_global.platform)if(this.gte(_global.platform_version,"1.5.0"))this.doCall("gotoNative",e);else switch(e.page){case"addGoods":this.doCall("addGoodsToShop",{alias:e.alias,seller_goods_alias:e.seller_goods_alias})}else this.doCall("gotoNative",e)},doAction:function(e){if("youzanwxd"===_global.platform)if(this.gte(_global.platform_version,"1.5.0"))this.doCall("doAction",e);else switch(e.action){case"back":this.doCall("gotoLogin",{});break;case"appWXPay":this.doCall("appWXPay",{kdt_id:e.kdt_id,order_no:e.order_no});break;case"deliverGoods":this.doCall("deliverGoods",{order_number:e.order_number})}else if("youzanwsc"===_global.platform)if(this.gte(_global.platform_version,"2.8.5"))this.doCall("doAction",e);else switch(e.action){case"back":this.doCall("previousStep",{})}},onAddGoodsSuccess:function(e){window.onReady("YouzanJSBridge",function(){window.YouzanJSBridge.on("addGoodsSuccess",function(t){e(t)})})},on:function(e,t){window.onReady("YouzanJSBridge",function(){window.YouzanJSBridge.on("dataReady",function(o){var a=o.datatype,i=o.data,n={};if("object"==typeof i)n=i;else try{n=JSON.parse(i)}catch(e){}a===e&&t(n)})})}}}),require(["zenjs/multi_uploader/main","wap/components/app_h5/main"],function(e,t){var o=new e({el:$(".js-input-container")}).render(),a=$(".js-submit");a.on("click",function(){if(a.hasClass("disabled"))return motify.log("正在提交中..."),!1;var e={kdt_goods_id:$('input[name="kdt_goods_id"]').val(),remark:$('textarea[name="remark"]').val(),reasons:[],attachment_ids:[]};$('input[name="reasons"]').each(function(t,o){o.checked&&e.reasons.push(Number(o.value))});var i=o.getFullData();return 0!==i.status?(motify.log(i.msg),!1):(_.each(i.data,function(t){e.attachment_ids.push(t.attachment_id)}),0===e.reasons.length?(motify.log("请先选择举报理由"),!1):_.contains(e.reasons,7)&&""===e.remark?(motify.log("请输入详细描述"),!1):e.remark.length>140?(motify.log("详细描述不超过140字"),!1):(a.addClass("disabled").html("提交中..."),void $._ajax({url:"/v2/fenxiao/goods/report.json?access_token="+(_global.access_token||""),type:"PUT",data:e,success:function(e){0===e.code?(motify.log("举报成功"),a.addClass("disabled").html("提交"),setTimeout(function(){t.doAction({action:"back"})},500)):(motify.log(e.msg),a.removeClass("disabled").html("提交"))},error:function(e){motify.log(e),a.removeClass("disabled").html("提交")}})))})}),define("main",function(){});