define("zenjs/uploader/photo_uploader",["require","bower_components/ajax/ajax","../util/ua"],function(t){t("bower_components/ajax/ajax");var e=t("../util/ua"),n=function(){},i=window._global,a=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var t=document.createElement("input");return t.type="file",!t.disabled},o=function(){var t="youzanwsc"===i.platform&&i.platform_version<="3.0.0";return!(e.getIOSVersion()>=9&&t)};return Backbone.View.extend({initialize:function(t){this.nInput=this.$("input"),this.nUploader=this.$("button"),this.save_to_shop=t.save_to_shop||!1,this.onValidUpload=t.onValidUpload||function(){return!0},this.onStartReadFile=t.onStartReadFile||n,this.onFinishReadFile=t.onFinishReadFile||n,this.onBeforeUpload=t.onBeforeUpload||n,this.onUploadSuccess=t.onUploadSuccess||n,this.onUploadError=t.onUploadError||n,this.onGetToken=t.onGetToken},events:{"click input":"onInputClicked","change input":"onFileChanged"},render:function(t){a()||(this.nInput.attr("disabled","disabled"),this.nUploader.css("padding-left","10px").html("您的浏览器不支持图片上传").attr("disabled","disabled")),o()||this.nInput.on("click",function(t){t.preventDefault(),motify.log("暂不支持图片上传功能")})},onInputClicked:function(t){t.target.value=""},onFileChanged:function(t){var e=this,n=t.target.files;_.map(n,function(t,n,i){if(t.size>5242880)return void motify.log("图片太大啦~");if(e.onValidUpload({file:t})){e.onStartReadFile({file:t});var a=new FileReader;a.onload=function(n){e.onFinishReadFile({src:n.target.result,file:t})},a.readAsDataURL(t),e.getUploadToken(t)}})},getUploadToken:function(t){var e=this;if(this.uptoken)return void this.doUploadPhoto(t);var n=function(n){e.uptoken=n,e.doUploadPhoto(t)},i=function(){motify.log("上传图片失败，请重试")};if(this.onGetToken&&"function"==typeof this.onGetToken)return void this.onGetToken(n,i);var a=window._global.url.wap+"/materials/storage/pubImgUploadToken.json";"https:"===location.protocol&&(a=a.replace("http://","https://")),$._ajax({url:a,type:"post",dataType:"json",timeout:5e3,cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){},success:function(t){n(t.data.uptoken)},error:function(t,e,n){i()},complete:function(t,e){}})},doUploadPhoto:function(t){var e=this,n=new FormData;n.append("token",this.uptoken),n.append("file",t),this.save_to_shop===!1&&n.append("x:skip_save",1);var a=t.name.split("."),o="";a.length>1&&(o="."+a[a.length-1]),n.append("x:ext",o),$._ajax({url:"//up.qbox.me",type:"post",data:n,dataType:"json",processData:!1,contentType:!1,timeout:8e4,beforeSend:function(){e.onBeforeUpload({file:t}),e.nInput.data("uploaded","false"),e.trigger("data_change"),e.trigger("data_change:start")},success:function(n){var a=i.url.imgqn+"/"+n.data.attachment_file;e.onUploadSuccess({url:a,file:t,data:n.data}),e.nInput.data("value",a),e.nInput.data("uploaded","true"),e.trigger("data_change"),e.trigger("data_change:success",{url:a})},error:function(n,i,a){e.onUploadError({file:t}),"timeout"===i&&motify.log("网络环境不佳<br/>请稍后重试")},complete:function(t,e){}})}})}),define("zenjs/multi_uploader/model",[],function(){return Backbone.Model.extend({initialize:function(t){t=t||{},this.max_picture_num=t.max_picture_num||5,this.uploadFiles={},this.uploadingList=[]},validItem:function(t){return this.uploadFiles[t]?(motify.log("该图片已经上传过了~"),!1):this.countItem()>this.max_picture_num-1?(motify.log("最多只能上传"+this.max_picture_num+"张图片"),!1):(this.addItem(t),!0)},getAllPhoto:function(){return _.filter(_.pluck(this.uploadFiles,"url"),function(t){return!!t})},getFullData:function(){return _.pluck(this.uploadFiles,"fullData")},isFinishLoading:function(){return!this.uploadingList.length},startUploading:function(t,e){this.uploadingList.push(t)},finishUploading:function(t){var e=this.uploadingList.indexOf(t);e>-1&&this.uploadingList.splice(e,1)},getItem:function(t){return(this.uploadFiles[t]||{}).el},updateItem:function(t,e){this.uploadFiles[t]&&_.extend(this.uploadFiles[t],e||{})},addItem:function(t,e,n){this.uploadFiles[t]=this.uploadFiles[t]||{},this.uploadFiles[t].el=e,this.uploadFiles[t].url=n},removeItem:function(t){delete this.uploadFiles[t];var e=this.uploadingList.indexOf(t);e>-1&&this.uploadingList.splice(e,1)},countItem:function(){return _.size(this.uploadFiles)}})}),define("text!zenjs/multi_uploader/templates/upload_image.html",[],function(){return"<span class=\"picture-wrapper\">\n\t<i class='js-delete-picture delete-picture' data-key='<%= data.key %>'></i>\n\t<img src='<%= data.src %>' alt=''>\n</span>\n"}),define("zenjs/util/number",[],function(){return{makeRandomString:function(t){var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";t=t||10;for(var i=0;i<t;i++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}}}),define("zenjs/multi_uploader/main",["require","../uploader/photo_uploader","./model","text!./templates/upload_image.html","../util/number"],function(t){var e=t("../uploader/photo_uploader"),n=t("./model"),i=t("text!./templates/upload_image.html"),a=t("../util/number"),o=_.template(i),s=function(){};return Backbone.View.extend({initialize:function(t){var i=this;this.files=t.files||[],this.max_picture_num=t.max_picture_num||5,this.onUploadStart=t.onUploadStart||s,this.onUploadSuccess=t.onUploadSuccess||s,this.onUploadError=t.onUploadError||s,this.onAddImageBtnShow=t.onAddImageBtnShow||s,this.onAddImageBtnHide=t.onAddImageBtnHide||s,this.nAddImage=this.$(".js-add-picture"),this.model=t.model||new n({max_picture_num:this.max_picture_num}),this.photoUploader=new e({el:this.el,skip_save:t.save_to_shop||!1,onStartReadFile:function(t){var e=i.generatekey(t);i.model.addItem(e);var n=i.addSingleItem({src:"",key:e});n.addClass("loading"),i.refreshAddImageBtn(),i.model.addItem(e,n),i.model.startUploading(e),i.onUploadStart(t,e,n),i.trigger("data_change"),i.trigger("data_change:start")},onFinishReadFile:function(t){var e=i.generatekey(t);i.model.getItem(e).find("img").attr("src",t.src)},onUploadSuccess:function(t){var e=i.generatekey(t),n=i.model.getItem(e);n&&(n.removeClass("loading"),i.model.finishUploading(e),i.model.updateItem(e,{url:t.url,fullData:t.data}),n.find("img").attr("src",t.url+"!100x100.jpg"),n.find("img").data("src",t.url),i.onUploadSuccess(t,e,n),i.trigger("data_change"),i.trigger("data_change:success"))},onUploadError:function(t){var e=i.generatekey(t),n=i.removeSingleItem(e);i.onUploadError(t,e,n),i.trigger("data_change"),i.trigger("data_change:remove")},onValidUpload:function(t){var e=t.file.name+"_"+t.file.size;return i.model.validItem(e)}})},render:function(){var t=this;return _.map(this.files,function(e,n,i){var n=t.generatekey(),a=t.addSingleItem({src:e,key:n});t.model.addItem(n,a,e)}),this.refreshAddImageBtn(),this.photoUploader.render(),this},events:{"click .delete-picture":"deletePicture"},generatekey:function(t){return t?t.file.name+"_"+t.file.size:(new Date).getTime()+a.makeRandomString()},deletePicture:function(t){var e=$(t.target).data("key");this.removeSingleItem(e),this.trigger("data_change"),this.trigger("data_change:remove")},removeSingleItem:function(t){var e=this.model.getItem(t);return e.remove(),this.model.removeItem(t),this.refreshAddImageBtn(),e},addSingleItem:function(t){var e=$(o({data:t}));return this.nAddImage.before(e),e},refreshAddImageBtn:function(){this.model.countItem()>this.max_picture_num-1?(this.nAddImage.hide(),this.onAddImageBtnHide()):(this.nAddImage.show(),this.onAddImageBtnShow())},getPhotos:function(){var t=this.model.getAllPhoto();return this.model.isFinishLoading()?{status:0,msg:"",data:t}:{status:102,msg:"图片正在上传中，请稍等",data:t}},getFullData:function(){var t=this.model.getFullData();return this.model.isFinishLoading()?{status:0,msg:"",data:t}:{status:102,msg:"图片正在上传中，请稍等",data:t}},countItem:function(){return this.model.countItem()}})}),define("wap/components/message_form/index",["zenjs/multi_uploader/main"],function(t){var e=function(){};return Backbone.View.extend({initialize:function(n){this.nPhotoContainer=n.nPhotoContainer||this.$(".js-photo-container"),this.nTextArea=n.nTextArea||this.$(".js-text"),this.nSubmit=n.nSubmit||this.$(".js-submit"),this.submitUrl=n.submitUrl||"",this.getExternalData=n.getExternalData||e,this.onSuccess=n.onSuccess||e,this.max_picture_num=n.max_picture_num||3,this.pic_url_type=n.pic_url_type||"attachment_file",this.onBeforeSend=n.onBeforeSend,this.photoView=new t({el:this.nPhotoContainer,max_picture_num:this.max_picture_num})},events:{"click .js-submit":"onSubmitClick","focus .js-message":"focusMessage","blur .js-message":"blurMessage"},onSubmitClick:function(t){t.preventDefault();var e=this;if(!this.isSubmiting){var n=$.trim(this.nTextArea.val()),i=this.photoView.getFullData()||{};if(0!==i.status)return void motify.log(i.msg);var a=_.filter(_.pluck(i.data,e.pic_url_type),function(t){return!!t});if(!n)return void motify.log("写点什么吧");if(n.length>500)return void motify.log("写的太多啦");this.isSubmiting=!0,this.nSubmit.attr("disabled","disabled");var o={message:n,ext_info:a};o=$.extend(o,this.getExternalData()||{}),this.onBeforeSend&&this.onBeforeSend(o),$._ajax({url:this.submitUrl,type:"POST",dataType:"json",data:o,success:function(t){var n=t.code,i=t.data||{};e.onSuccess(n,i,t),e.nSubmit.removeAttr("disabled")},error:function(){e.nSubmit.removeAttr("disabled")},complete:function(){e.isSubmiting=!1}})}},focusMessage:function(t){$(t.target).addClass("active")},blurMessage:function(t){$(t.target).removeClass("active")}})}),require(["wap/components/message_form/index"],function(t){new(Backbone.View.extend({initialize:function(e){this._global=e._global||{},this.messageForm=new t({el:this.$el,submitUrl:"/v2/trade/safe/involve.json",onSuccess:_(this.onSuccess).bind(this),getExternalData:_(this.getExternalData).bind(this)})},getExternalData:function(){return{safe_no:this._global.safe_no}},onSuccess:function(t,e,n){var i=this._global.url.trade+"/v2/trade/safe/info?safe_no="+this._global.safe_no;0===t?(motify.log("提交成功，正在跳转中"),window.location.href=i):10500===t?(motify.log(n.msg),setTimeout(function(){window.location.href=i},800)):motify.log(n.msg)}}))({el:$("body"),_global:window._global})}),define("main",function(){});