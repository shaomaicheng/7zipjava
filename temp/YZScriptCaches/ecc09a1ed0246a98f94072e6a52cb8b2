define("zenjs/uploader/photo_uploader",["require","bower_components/ajax/ajax","../util/ua"],function(t){t("bower_components/ajax/ajax");var e=t("../util/ua"),i=function(){},o=window._global,n=function(){if(navigator.userAgent.match(/(Android (1.0|1.1|1.5|1.6|2.0|2.1))|(Windows Phone (OS 7|8.0))|(XBLWP)|(ZuneWP)|(w(eb)?OSBrowser)|(webOS)|(Kindle\/(1.0|2.0|2.5|3.0))/))return!1;var t=document.createElement("input");return t.type="file",!t.disabled},s=function(){var t="youzanwsc"===o.platform&&o.platform_version<="3.0.0";return!(e.getIOSVersion()>=9&&t)};return Backbone.View.extend({initialize:function(t){this.nInput=this.$("input"),this.nUploader=this.$("button"),this.save_to_shop=t.save_to_shop||!1,this.onValidUpload=t.onValidUpload||function(){return!0},this.onStartReadFile=t.onStartReadFile||i,this.onFinishReadFile=t.onFinishReadFile||i,this.onBeforeUpload=t.onBeforeUpload||i,this.onUploadSuccess=t.onUploadSuccess||i,this.onUploadError=t.onUploadError||i,this.onGetToken=t.onGetToken},events:{"click input":"onInputClicked","change input":"onFileChanged"},render:function(t){n()||(this.nInput.attr("disabled","disabled"),this.nUploader.css("padding-left","10px").html("您的浏览器不支持图片上传").attr("disabled","disabled")),s()||this.nInput.on("click",function(t){t.preventDefault(),motify.log("暂不支持图片上传功能")})},onInputClicked:function(t){t.target.value=""},onFileChanged:function(t){var e=this,i=t.target.files;_.map(i,function(t,i,o){if(t.size>5242880)return void motify.log("图片太大啦~");if(e.onValidUpload({file:t})){e.onStartReadFile({file:t});var n=new FileReader;n.onload=function(i){e.onFinishReadFile({src:i.target.result,file:t})},n.readAsDataURL(t),e.getUploadToken(t)}})},getUploadToken:function(t){var e=this;if(this.uptoken)return void this.doUploadPhoto(t);var i=function(i){e.uptoken=i,e.doUploadPhoto(t)},o=function(){motify.log("上传图片失败，请重试")};if(this.onGetToken&&"function"==typeof this.onGetToken)return void this.onGetToken(i,o);var n=window._global.url.wap+"/materials/storage/pubImgUploadToken.json";"https:"===location.protocol&&(n=n.replace("http://","https://")),$._ajax({url:n,type:"post",dataType:"json",timeout:5e3,cache:!1,xhrFields:{withCredentials:!0},beforeSend:function(){},success:function(t){i(t.data.uptoken)},error:function(t,e,i){o()},complete:function(t,e){}})},doUploadPhoto:function(t){var e=this,i=new FormData;i.append("token",this.uptoken),i.append("file",t),this.save_to_shop===!1&&i.append("x:skip_save",1);var n=t.name.split("."),s="";n.length>1&&(s="."+n[n.length-1]),i.append("x:ext",s),$._ajax({url:"//up.qbox.me",type:"post",data:i,dataType:"json",processData:!1,contentType:!1,timeout:8e4,beforeSend:function(){e.onBeforeUpload({file:t}),e.nInput.data("uploaded","false"),e.trigger("data_change"),e.trigger("data_change:start")},success:function(i){var n=o.url.imgqn+"/"+i.data.attachment_file;e.onUploadSuccess({url:n,file:t,data:i.data}),e.nInput.data("value",n),e.nInput.data("uploaded","true"),e.trigger("data_change"),e.trigger("data_change:success",{url:n})},error:function(i,o,n){e.onUploadError({file:t}),"timeout"===o&&motify.log("网络环境不佳<br/>请稍后重试")},complete:function(t,e){}})}})}),define("zenjs/multi_uploader/model",[],function(){return Backbone.Model.extend({initialize:function(t){t=t||{},this.max_picture_num=t.max_picture_num||5,this.uploadFiles={},this.uploadingList=[]},validItem:function(t){return this.uploadFiles[t]?(motify.log("该图片已经上传过了~"),!1):this.countItem()>this.max_picture_num-1?(motify.log("最多只能上传"+this.max_picture_num+"张图片"),!1):(this.addItem(t),!0)},getAllPhoto:function(){return _.filter(_.pluck(this.uploadFiles,"url"),function(t){return!!t})},getFullData:function(){return _.pluck(this.uploadFiles,"fullData")},isFinishLoading:function(){return!this.uploadingList.length},startUploading:function(t,e){this.uploadingList.push(t)},finishUploading:function(t){var e=this.uploadingList.indexOf(t);e>-1&&this.uploadingList.splice(e,1)},getItem:function(t){return(this.uploadFiles[t]||{}).el},updateItem:function(t,e){this.uploadFiles[t]&&_.extend(this.uploadFiles[t],e||{})},addItem:function(t,e,i){this.uploadFiles[t]=this.uploadFiles[t]||{},this.uploadFiles[t].el=e,this.uploadFiles[t].url=i},removeItem:function(t){delete this.uploadFiles[t];var e=this.uploadingList.indexOf(t);e>-1&&this.uploadingList.splice(e,1)},countItem:function(){return _.size(this.uploadFiles)}})}),define("text!zenjs/multi_uploader/templates/upload_image.html",[],function(){return"<span class=\"picture-wrapper\">\n\t<i class='js-delete-picture delete-picture' data-key='<%= data.key %>'></i>\n\t<img src='<%= data.src %>' alt=''>\n</span>\n"}),define("zenjs/util/number",[],function(){return{makeRandomString:function(t){var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";t=t||10;for(var o=0;o<t;o++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}}}),define("zenjs/multi_uploader/main",["require","../uploader/photo_uploader","./model","text!./templates/upload_image.html","../util/number"],function(t){var e=t("../uploader/photo_uploader"),i=t("./model"),o=t("text!./templates/upload_image.html"),n=t("../util/number"),s=_.template(o),a=function(){};return Backbone.View.extend({initialize:function(t){var o=this;this.files=t.files||[],this.max_picture_num=t.max_picture_num||5,this.onUploadStart=t.onUploadStart||a,this.onUploadSuccess=t.onUploadSuccess||a,this.onUploadError=t.onUploadError||a,this.onAddImageBtnShow=t.onAddImageBtnShow||a,this.onAddImageBtnHide=t.onAddImageBtnHide||a,this.nAddImage=this.$(".js-add-picture"),this.model=t.model||new i({max_picture_num:this.max_picture_num}),this.photoUploader=new e({el:this.el,skip_save:t.save_to_shop||!1,onStartReadFile:function(t){var e=o.generatekey(t);o.model.addItem(e);var i=o.addSingleItem({src:"",key:e});i.addClass("loading"),o.refreshAddImageBtn(),o.model.addItem(e,i),o.model.startUploading(e),o.onUploadStart(t,e,i),o.trigger("data_change"),o.trigger("data_change:start")},onFinishReadFile:function(t){var e=o.generatekey(t);o.model.getItem(e).find("img").attr("src",t.src)},onUploadSuccess:function(t){var e=o.generatekey(t),i=o.model.getItem(e);i&&(i.removeClass("loading"),o.model.finishUploading(e),o.model.updateItem(e,{url:t.url,fullData:t.data}),i.find("img").attr("src",t.url+"!100x100.jpg"),i.find("img").data("src",t.url),o.onUploadSuccess(t,e,i),o.trigger("data_change"),o.trigger("data_change:success"))},onUploadError:function(t){var e=o.generatekey(t),i=o.removeSingleItem(e);o.onUploadError(t,e,i),o.trigger("data_change"),o.trigger("data_change:remove")},onValidUpload:function(t){var e=t.file.name+"_"+t.file.size;return o.model.validItem(e)}})},render:function(){var t=this;return _.map(this.files,function(e,i,o){var i=t.generatekey(),n=t.addSingleItem({src:e,key:i});t.model.addItem(i,n,e)}),this.refreshAddImageBtn(),this.photoUploader.render(),this},events:{"click .delete-picture":"deletePicture"},generatekey:function(t){return t?t.file.name+"_"+t.file.size:(new Date).getTime()+n.makeRandomString()},deletePicture:function(t){var e=$(t.target).data("key");this.removeSingleItem(e),this.trigger("data_change"),this.trigger("data_change:remove")},removeSingleItem:function(t){var e=this.model.getItem(t);return e.remove(),this.model.removeItem(t),this.refreshAddImageBtn(),e},addSingleItem:function(t){var e=$(s({data:t}));return this.nAddImage.before(e),e},refreshAddImageBtn:function(){this.model.countItem()>this.max_picture_num-1?(this.nAddImage.hide(),this.onAddImageBtnHide()):(this.nAddImage.show(),this.onAddImageBtnShow())},getPhotos:function(){var t=this.model.getAllPhoto();return this.model.isFinishLoading()?{status:0,msg:"",data:t}:{status:102,msg:"图片正在上传中，请稍等",data:t}},getFullData:function(){var t=this.model.getFullData();return this.model.isFinishLoading()?{status:0,msg:"",data:t}:{status:102,msg:"图片正在上传中，请稍等",data:t}},countItem:function(){return this.model.countItem()}})}),define("bower_components/pop/pop",["require","zenjs/events","zenjs/util/number"],function(t){var e=function(){},i=t("zenjs/events"),o=t("zenjs/util/number");return window.zenjs=window.zenjs||{},i.extend({init:function(t){this._window=$(window);var i=o.makeRandomString();$("body").append('<div id="'+i+'"                 style="display:none; height: 100%;                 position: fixed; top: 0; left: 0; right: 0;                background-color: rgba(0, 0, 0, '+(t.transparent||".7")+');z-index:1000;opacity:0;transition: opacity ease 0.2s;"></div>'),this.nBg=$("#"+i),this.nBg.on("click",$.proxy(function(){this.isCanNotHide||this.hide()},this));var n=o.makeRandomString();$("body").append('<div id="'+n+'" class="'+(t.className||"")+'" style="overflow:hidden;visibility: hidden;"></div>'),this.nPopContainer=$("#"+n),this.nPopContainer.hide(),this.nPopContainer.css({opacity:0,position:"absolute","z-index":1e3}),t.contentViewClass&&(this.contentViewClass=t.contentViewClass,this.contentViewOptions=$.extend({el:this.nPopContainer},t.contentViewOptions||{}),this.contentView=new this.contentViewClass($.extend({onHide:$.proxy(this.hide,this)},this.contentViewOptions)),this.contentView.onHide=$.proxy(this.hide,this)),this.animationTime=t.animationTime||300,this.isCanNotHide=t.isCanNotHide,this.doNotRemoveOnHide=t.doNotRemoveOnHide||!1,this.onShow=t.onShow||e,this.onHide=t.onHide||e,this.onFinishHide=t.onFinishHide||e,this.html=t.html},render:function(t){return this.renderOptions=t||{},this.contentViewClass?this.contentView.render(this.renderOptions):this.html&&this.nPopContainer.html(this.html),this},show:function(){return this.nBg.show().css({opacity:"1","transition-property":"none"}),this.nPopContainer.show(),this.trigger("pop:show:before"),setTimeout($.proxy(function(){this.trigger("pop:show:after"),this.nPopContainer.show().css("visibility","visible"),this._doShow&&this._doShow(),this.onShow()},this),200),this},hide:function(t){t=t||{};var e=t.doNotRemove||this.doNotRemoveOnHide||!1;this._doHide&&this._doHide(),this.trigger("pop:hide:before"),setTimeout($.proxy(function(){this.nBg.css({opacity:0,"transition-property":"opacity"}),this.trigger("pop:hide:after"),setTimeout($.proxy(function(){this.nBg.hide(),this.nPopContainer.hide(),e||this.destroy()},this),200)},this),this.animationTime),this.onHide()},destroy:function(){return this.nPopContainer.remove(),this.nBg.remove(),this.contentView&&this.contentView.remove(),this}})}),define("bower_components/pop/pop_forbid_scroll",["require","./pop"],function(t){return window.zenjs=window.zenjs||{},t("./pop").extend({init:function(t){this._super(t),t.doNotForbidScroll||(this.on("pop:show:before",$.proxy(this.onBeforePopShow,this)),this.on("pop:show:after",$.proxy(this.onAfterPopShow,this)),this.on("pop:hide:after",$.proxy(this.onAfterPopHide,this)))},onBeforePopShow:function(){this.top=this._window.scrollTop()},onAfterPopShow:function(){this._window.scrollTop(0),this.startShow()},onAfterPopHide:function(){var t,e=function(i){if(t!==this._window.scrollTop()&&i>0)return this._window.scrollTop(t),void setTimeout($.proxy(e,this,i-1));setTimeout($.proxy(this.onFinishHide,this),50)};return function(){this.startHide(),t=this.top,this._window.scrollTop(t),$.proxy(e,this)(2),setTimeout($.proxy(function(){window.zenjs.popList.length<1&&$("html").css("position",this.htmlPosition)},this),200)}}(),startShow:function(){var t=window.zenjs.popList;if(t||(t=window.zenjs.popList=[]),0===t.length){var e=$("body"),i=$("html");this.htmlPosition=i.css("position"),i.css("position","relative"),this.bodyCss=(e.prop("style")||{}).cssText,this.htmlCss=(i.prop("style")||{}).cssText,$("body,html").css({overflow:"hidden",height:this._window.height(),"padding-bottom":0,"margin-bottom":0})}t.indexOf(this)<0&&t.push(this)},startHide:function(){var t=window.zenjs.popList,e=t.indexOf(this);e>-1&&t.splice(e,1),t.length<1&&($("html").attr("style",this.htmlCss||""),$("body").attr("style",this.bodyCss||""))}})}),define("bower_components/pop/popout",["require","./pop_forbid_scroll"],function(t){return t("./pop_forbid_scroll").extend({init:function(t){t=t||{},this._super(t),this.css=$.extend({transition:"opacity ease "+this.animationTime+"ms",top:"50%",left:"50%","-webkit-transform":"translate3d(-50%, -50%, 0)",transform:"translateY(-50%, -50%, 0)"},t.css||{}),this.nPopContainer.css(this.css)},_doShow:function(){$(".js-popout-close").click($.proxy(function(t){this.hide()},this)),this.nPopContainer.css("opacity",1),this.nPopContainer.show()},_doHide:function(t){this.nPopContainer.css({opacity:0})}})}),define("bower_components/pop/popout_box",["require","./popout"],function(t){var e=function(){};return t("./popout").extend({init:function(t){this._super(t),this._onOKClicked=t.onOKClicked||e,this._onCancelClicked=t.onCancelClicked||e,this.preventHideOnOkClicked=t.preventHideOnOkClicked||!1,this.width=t.width,this.setEventListener()},setEventListener:function(){this.nPopContainer.on("click",".js-ok",$.proxy(this.onOKClicked,this)),this.nPopContainer.on("click",".js-cancel",$.proxy(this.onCancelClicked,this))},_doShow:function(){this.boxCss={"border-radius":"4px",background:"white",width:this.width||"270px",padding:"15px"},this.nPopContainer.css(this.boxCss).addClass("popout-box"),this._super()},_doHide:function(t){this._super()},onOKClicked:function(t){this._onOKClicked(t),!this.preventHideOnOkClicked&&this.hide()},onCancelClicked:function(t){this._onCancelClicked(t),this.hide()}})}),define("text!wap/fenxiao/comment/templates/comment_tip.html",[],function(){return'<h3 class="comment-tip-title">评分说明</h3>\n<div class="comment-tip-content">\n    <h3>订单处理</h3>\n    <p>对订单发货、售后、维权等问题的处理效率的满意度评分</p>\n    <h3>分销支持</h3>\n    <p>对分销产品的定价、利润空间、分销政策的满意度评分</p>\n    <h3>营销指导</h3>\n    <p>对商详制作、答疑解惑、活动支持、培训指导方面的满意度评分</p>\n</div>\n<div class="js-cancel comment-tip-close">我知道了</div>\n'}),define("wap/fenxiao/comment/views/main",["require","exports","module","zenjs/multi_uploader/main","bower_components/pop/popout_box","text!wap/fenxiao/comment/templates/comment_tip.html","bower_components/youzanjsbridge/api"],function(t,e,i){var o=t("zenjs/multi_uploader/main"),n=t("bower_components/pop/popout_box"),s=t("text!wap/fenxiao/comment/templates/comment_tip.html"),a=t("bower_components/youzanjsbridge/api");i.exports=Backbone.View.extend({el:"body",events:{"click .js-type-btn":"selectFeelType","click .js-score-item":"selectScore","click .js-comment-tip":"showCommentTip","click .js-publish-comment":"onPublishComment","click .js-gotoDetail":"onGotoDetail","click .js-gotoHomepage":"onGotoHomepage","click .js-gotoHistory":"onGotoHistory","click .delete-picture":"onDeletePicutre","change .js-comment-content":"onWriteContent"},initialize:function(t){this.scoreMap={1:"more_negative",2:"negative",3:"average",4:"favorable",5:"more_favorable"},this.initUploadImg(),this.commentType=this.$(".js-feel-region").data("comment-type"),"comment_step"!=this.commentType&&"reply_step"!=this.commentType||this.initScore(),this.model=t.model,this.listenTo(this.model,"change",function(){this.canPost=!0}.bind(this)),this.listenTo(this.model,"fetchSuccess",function(){window.location.href=_global.url.wap+"/kdtapp/order/detail?order_number="+this.model.get("buyer_order_no")+"&access_token="+this.model.get("access_token")}.bind(this)),this.listenTo(this.model,"publishFail",function(){this.$(".js-publish-btn").css("background-color","#49c131").addClass("js-publish-comment").text("发表评价")}.bind(this)),this.render()},parseImgUrl:function(t){return t&&t.length?_.map(t,function(t){return window._global.url.imgqn+"/"+t+"?imageView2/0/w/100"}):[]},clearImgUrl:function(t){return t&&t.length?_.map(t,function(t){var e=window._global.url.imgqn+"/",i=new RegExp(e,"g");return t.replace(i,"").replace("?imageView2/0/w/100","")}):[]},onDeletePicutre:function(){this.model.trigger("change")},initUploadImg:function(){var t=this;this.uploaderImg=new o({el:$(".js-input-container"),max_picture_num:6,files:this.parseImgUrl(_global.comment_image_list)||[],onUploadStart:function(){t.isUpload=!0},onUploadSuccess:function(){t.isUpload=!1,t.model.trigger("change")}}),this.uploaderImg.render()},initScore:function(){this.$(".js-score-item").each(function(t,e){var i=$(e).data("type"),o=$(e).data("score"),n=this.scoreMap[o];i&&o&&this.model.set(i,n)}.bind(this));var t=this.$(".js-type-btn.active").data("feel");t&&this.model.set("total_score",t),this.model.set("content",this.$(".js-comment-content").val()),this.initPictures()},initPictures:function(){var t=_global.comment_image_list;this.model.set("pictures",t||[])},setPictures:function(){var t=this.uploaderImg.getPhotos().data;t&&this.model.set("pictures",this.clearImgUrl(t)||[])},selectFeelType:function(t){var e=$(t.currentTarget),i=e.data("feel");this.$(".js-type-btn").removeClass("active"),this.model.set("total_score",i),e.addClass("active")},selectScore:function(t){var e=$(t.target),i=$(t.currentTarget).data("type");if(e.data("score")&&"LI"==e.get(0).tagName){var o=e.data("score"),n=this.scoreMap[o];e.parent().removeClass().addClass("select-"+o+"-star"),this.model.set(i,n)}},showCommentTip:function(){new n({isCanNotHide:!1,html:_.template(s)()}).render().show()},onWriteContent:function(t){var e=$(t.currentTarget),i=_.escape($.trim(e.val()));i&&this.model.set("content",i)},onPublishComment:function(){if(this.$(".js-comment-content").trigger("blur"),this.setPictures(),this.isUpload)return void motify.log("图片正在上传中，请稍等");this.canPost?(this.$(".js-publish-btn").removeClass("js-publish-comment").css("background-color","#ddd").text("发表中..."),this.model.fetch(this.commentType)):motify.log("请勿提交重复信息")},onGotoHomepage:function(t){var e=$(t.target).data("supplier-kdt-id");e&&a.gotoWebview({page:"supplierHomepage",url:_global.url.wap+"/fenxiao/supplier/index?supplier_kdt_id="+e})},onGotoDetail:function(t){var e=$(t.currentTarget).data("alias");e&&a.gotoWebview({page:"web",url:_global.url.wap+"/showcase_fenxiao/goods/active?alias="+e})},onGotoHistory:function(){a.gotoWebview({page:"web",url:_global.url.wap+"/fenxiao/comment/history?order_no="+this.model.get("order_no")+"&sku_id="+this.model.get("sku_id")})},render:function(){return this}})}),define("wap/fenxiao/comment/models/model",["require","exports","module","zenjs/util/args"],function(t,e,i){var o=t("zenjs/util/args");i.exports=Backbone.Model.extend({defaults:{order_no:o.get("order_no"),sku_id:o.get("sku_id"),access_token:o.get("access_token"),buyer_order_no:o.get("buyer_order_no"),total_score:"",content:"",pictures:[],order_score:"",fx_support_score:"",marketing_guidance_score:""},initialize:function(){},verifyData:function(){return this.get("order_no")&&this.get("sku_id")&&this.get("access_token")&&this.get("buyer_order_no")?this.get("total_score")?!!(this.get("order_score")&&this.get("fx_support_score")&&this.get("marketing_guidance_score"))||(motify.log("请对所有评价进行评分"),this.trigger("publishFail"),!1):(motify.log("请选择总体感受～"),this.trigger("publishFail"),!1):(motify.log("数据错误"),this.trigger("publishFail"),!1)},baseComment:function(t){var e=this;this.verifyData()&&$._ajax({url:t.url,type:"POST",data:_.pick(this.toJSON(),"access_token","order_no","sku_id","total_score","content","pictures","order_score","fx_support_score","marketing_guidance_score"),success:function(t){"0"==t.code?(motify.log("评价提交成功，<br>页面跳转中..."),e.trigger("fetchSuccess")):(motify.log(t.msg||"提交失败"),e.trigger("publishFail"))},error:function(t){motify.log(t),e.trigger("publishFail")}})},creatComment:function(){this.baseComment({url:"/v2/fenxiao/comment/create.json"})},editComment:function(){this.baseComment({url:"/v2/fenxiao/comment/edit.json"})},appendComment:function(){this.baseComment({url:"/v2/fenxiao/comment/append.json"})},fetch:function(t){"empty_comment"==t&&this.creatComment(),"comment_step"==t&&this.editComment(),"reply_step"==t&&this.appendComment()}})}),define("wap/fenxiao/comment/router/router",["require","wap/fenxiao/comment/views/main","wap/fenxiao/comment/models/model"],function(t){var e=t("wap/fenxiao/comment/views/main"),i=t("wap/fenxiao/comment/models/model");return Backbone.Router.extend({routes:{"":"renderInitView"},initialize:function(){this.model=new i},renderInitView:function(){new e({model:this.model})}})}),require(["wap/fenxiao/comment/router/router"],function(t){new t,Backbone.history.start()}),define("main",function(){});